<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: Linux | 不停地疯]]></title>
  <link href="http://blog.xeonxu.info/blog/categories/Linux/atom.xml" rel="self"/>
  <link href="http://blog.xeonxu.info/"/>
  <updated>2012-12-02T15:44:26+08:00</updated>
  <id>http://blog.xeonxu.info/</id>
  <author>
    <name><![CDATA[Xeon Xu]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[在Linux内核模块中操作I2C设备]]></title>
    <link href="http://blog.xeonxu.info/blog/2012/11/25/zai-linuxnei-he-zhong-yi-mo-kuai-fang-shi-cao-zuo-i2cshe-bei/"/>
    <updated>2012-11-25T00:02:00+08:00</updated>
    <id>http://blog.xeonxu.info/blog/2012/11/25/zai-linuxnei-he-zhong-yi-mo-kuai-fang-shi-cao-zuo-i2cshe-bei</id>
    <content type="html"><![CDATA[<p>
近期公司项目较为空闲，抽空做了一些学习性质的研发内容，其中涉及到在Linux内核模块中使用I2C对外部器件进行控制的操作。虽然在Linux中操作使用I2C设备并不复杂，但本人接触Linux内核驱动开发时间并不算长，此次学习中也算较为系统的了解了Linux中对I2C设备的操控方式，谨在此做下记录。
</p>
<p>
通过Linux内核文档中关于操作I2C设备的文章后不难看出Linux中注册使用I2C设备一般通过四种方法<sup><a class="footref" name="fnr.1" href="#fn.1">1</a></sup>：
</p>
<ol>
<li>通过总线号声明设备
</li>
<li>立即探测设备
</li>
<li>通过Probe探测相应设备
</li>
<li>在用户空间立即探测
</li>
</ol>

<p>
简单来说，第一种方式一般应用在嵌入式设备中。因为对于嵌入式设备来说，外围器件基本都是固定的，只需提供有限几款器件的支持即可。使用这种方式的时候，需要在板级配置文件中定义并设置 <code>i2c_board_info</code> 这个结构体的内容。其中需要配置设备名称和设备地址，此外设备中断和私有数据结构也可以选择设置。然后使用 <code>i2c_register_board_info</code> 这个接口对设置的设备进行注册使用。需要注意的是这种方法注册的设备是在注册I2C总线驱动时进行驱动适配的。
</p>
<p>
第二种方法可以通过给定的I2C适配器以及相应的I2C板级结构体，自行通过 <code>i2c_new_device</code> 接口进行添加注册所需的设备。这种方法灵活性要较第一种方法大，可以很方便的在模块中使用。
</p>
<p>
第三种方法是 <code>2.6</code> 内核之前的做法，使用 <code>detect</code> 方法去探测总线上的设备驱动。因为探测机制的原因，会导致一些副作用的发生，所以不建议使用，除非真的没有别的办法。
</p>
<p>
第四种方法是在Linux的控制台上，在用户空间通过sysfs，使用 <code>/sys/bus/i2c/devices/i2c-3/new_device</code> 节点进行设备的添加注册。
</p>
<p>
从上面可以看出，如果需要在Linux内核中以模块的方式对I2C设备进行驱动控制的话，第二种方法是比较推荐的。通过测试，在module的init中使用
<div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="k">struct</span> <span class="n">i2c_adapter</span> <span class="o">*</span><span class="n">i2c_adap</span><span class="p">;</span>
</span><span class='line'><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">i2c_client</span><span class="p">;</span>
</span><span class='line'><span class="n">i2c_adap</span> <span class="o">=</span> <span class="n">i2c_get_adapter</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span><span class='line'><span class="n">i2c_client</span> <span class="o">=</span> <span class="n">i2c_new_device</span><span class="p">(</span><span class="n">i2c_adap</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">amp</span><span class="p">;</span><span class="n">i2c_device</span><span class="p">);</span>
</span><span class='line'><span class="n">i2c_put_adapter</span><span class="p">(</span><span class="n">i2c_adap</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
即可成功注册I2C设备。其中:
<div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="k">static</span> <span class="k">struct</span> <span class="n">i2c_board_info</span> <span class="n">ft5306_i2c_device</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">I2C_BOARD_INFO</span><span class="p">(</span><span class="s">&quot;test_i2c&quot;</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">),</span>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

以上，对于如何在模块中注册使用I2C设备简单做了描述。那么如何在另外的模块中对已经注册的I2C设备进行反注册呢？由于内核中操作I2C设备都是通过 <code>i2c_client</code> 结构进行，所以问题可以抽象为如何在内核中获取指定设备的 <code>i2c_client</code> 结构指针。通过查阅内核API，也找到了一个方法可以达到这样的目的，如下：
<div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">i2c_client</span><span class="p">;</span>
</span><span class='line'><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">i2c_dev</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="n">i2c_dev</span> <span class="o">=</span> <span class="n">bus_find_device_by_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">amp</span><span class="p">;</span><span class="n">i2c_bus_type</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;1-0011&quot;</span><span class="p">);</span>
</span><span class='line'><span class="k">if</span><span class="p">(</span><span class="n">i2c_dev</span><span class="p">)</span>
</span><span class='line'>    <span class="n">i2c_client</span>  <span class="o">=</span>  <span class="n">container_of</span><span class="p">(</span><span class="n">i2c_dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">i2c_client</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
</span><span class='line'><span class="k">if</span><span class="p">(</span><span class="n">i2c_client</span><span class="p">)</span>
</span><span class='line'>    <span class="n">i2c_unregister_device</span><span class="p">(</span><span class="n">i2c_client</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
该反注册例子的内容就是对前面注册的 <code>0x11</code> 地址的设备进行反注册。注意 <code>bus_find_device_by_name</code> 函数中第三项参数，该参数是需要查找的设备在总线上注册的名称。"1"代表着1号适配器，"0011"是16位的I2C地址。如此便可方便的在内核模块中对I2C设备进行挂载和解挂了。
</p>
<div id="footnotes">
<h2 class="footnotes">Footnotes: </h2>
<div id="text-footnotes">
<p class="footnote"><sup><a class="footnum" name="fn.1" href="#fnr.1">1</a></sup> 参考Linux内核目录下的Documentation/i2c/instantiating-devices
</p>



</div>
</div>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[使用tmux改进终端体验]]></title>
    <link href="http://blog.xeonxu.info/blog/2012/11/04/shi-yong-tmuxgai-jin-zhong-duan-ti-yan/"/>
    <updated>2012-11-04T23:59:00+08:00</updated>
    <id>http://blog.xeonxu.info/blog/2012/11/04/shi-yong-tmuxgai-jin-zhong-duan-ti-yan</id>
    <content type="html"><![CDATA[<p>
之前一直使用GNU Screen作为我的终端管理软件，但是发现它和我使用的Emacs编辑器不兼容，其表现是画面会被无规律的撕裂，经常造成无法正常显示和编辑文件。虽然也尝试过不少配置方法，但是都没有效果。这迫使我去寻找GNU Screen的替代品，直到后来遇到<a href="http://tmux.sourceforge.net">tmux</a> ，才将我从混乱的画面中拯救出来。tmux和Emacs的兼容非常好，没有任何问题，这点让我非常满意。同时，tmux拥有强大的自定义能力，只需简单的配置，就可以使工作环境舒适度显著提高。
</p>
<p>
首先，先简单了解一下tmux。tmux顾名思义，取terminal multiplexer之意，及终端复用器，其源代码基于BSD协议进行开源和分发。使用上来说，tmux和GNU Screen大同小异，都是使用命令引导键来进行操作，不过tmux的默认引导键由Screen的 <code>C-a</code> 变更为了 <code>C-b</code> 。另外，常用命令也和Gnu Screen一样可以通过 <code>引导键 ?</code> 来查看。操作方法的近似，促使我下决心从GNU Screen转换到tmux下。考虑到tmux作为GNU Screen的改进实现，功能要高级许多，仅仅用来替代GNU Screen有点大材小用的感觉。所以为了更好的学习tmux，我从<a href="http://pragprog.com/book/bhtmux/tmux">The Pragmatic Bookshelf</a>购买了名叫 <b>tmux: Productive Mouse-Free Development</b> 的书，并花了3天时间将这本书读完，感到受益匪浅。之后，按照书中的建议配置了工作环境中的tmux，感觉非常好，极大提升了终端工作的效率。下面来看看我的配置：
</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><figcaption><span>.tmux.conf配置  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c"># 配置使用和GNU Screen相同的C-a作为命令引导键</span>
</span><span class='line'><span class="nb">set</span> -g prefix C-a
</span><span class='line'><span class="c"># 设置终端类型为256色</span>
</span><span class='line'><span class="nb">set</span> -g default-terminal “screen-256color”&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;h1 <span class="nv">id</span><span class="o">=</span><span class="s2">&quot;section&quot;</span>&gt;设置状态栏前景及背景色&lt;/h1&gt;
</span><span class='line'>&lt;p&gt;set -g status-bg colour23
</span><span class='line'><span class="nb">set</span> -g status-fg colour238&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;h1 <span class="nv">id</span><span class="o">=</span><span class="s2">&quot;section-1&quot;</span>&gt;设置窗口标签的前景及背景色&lt;/h1&gt;
</span><span class='line'>&lt;p&gt;setw -g window-status-fg colour232
</span><span class='line'>setw -g window-status-bg default
</span><span class='line'>setw -g window-status-attr dim&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;h1 <span class="nv">id</span><span class="o">=</span><span class="s2">&quot;section-2&quot;</span>&gt;设置当前窗口标签的前景及背景色&lt;/h1&gt;
</span><span class='line'>&lt;p&gt;setw -g window-status-current-fg colour88
</span><span class='line'>setw -g window-status-current-bg colour130
</span><span class='line'>setw -g window-status-current-attr bright&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;h1 <span class="nv">id</span><span class="o">=</span><span class="s2">&quot;section-3&quot;</span>&gt;设置窗口分割的边框颜色&lt;/h1&gt;
</span><span class='line'>&lt;p&gt;set -g pane-border-fg colour189
</span><span class='line'><span class="nb">set</span> -g pane-border-bg black&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;h1 <span class="nv">id</span><span class="o">=</span><span class="s2">&quot;section-4&quot;</span>&gt;设置当前窗口分割的边框颜色&lt;/h1&gt;
</span><span class='line'>&lt;p&gt;set -g pane-active-border-fg white
</span><span class='line'><span class="nb">set</span> -g pane-active-border-bg colour208&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;h1 <span class="nv">id</span><span class="o">=</span><span class="s2">&quot;section-5&quot;</span>&gt;设置提示信息的前景及背景色&lt;/h1&gt;
</span><span class='line'>&lt;p&gt;set -g message-fg colour232
</span><span class='line'><span class="nb">set</span> -g message-bg colour23
</span><span class='line'><span class="nb">set</span> -g message-attr bright&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;h1 <span class="nv">id</span><span class="o">=</span><span class="s2">&quot;section-6&quot;</span>&gt;设置状态栏左部宽度&lt;/h1&gt;
</span><span class='line'>&lt;p&gt;set -g status-left-length 40
</span><span class='line'><span class="c"># 设置状态栏显示内容和内容颜色。这里配置从左边开始显示，使用绿色显示session名称，黄色显示窗口号，蓝色显示窗口分割号</span>
</span><span class='line'><span class="nb">set</span> -g status-left “#<span class="o">[</span><span class="nb">fg</span><span class="o">=</span>colour52<span class="o">]</span><span class="c">#S #[fg=yellow]#I #[fg=cyan]#P”</span>
</span><span class='line'><span class="c"># 设置状态栏右部宽度</span>
</span><span class='line'><span class="nb">set</span> -g status-right-length 80
</span><span class='line'><span class="c"># 设置状态栏右边内容，这里设置为时间信息</span>
</span><span class='line'><span class="nb">set</span> -g status-right “#<span class="o">[</span><span class="nb">fg</span><span class="o">=</span>colour106<span class="o">]</span><span class="c">#(~/bin/system_info.sh) #[fg=colour208]|%d %b %R”</span>
</span><span class='line'><span class="c"># 窗口信息居中显示</span>
</span><span class='line'><span class="nb">set</span> -g status-justify centre&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;h1 <span class="nv">id</span><span class="o">=</span><span class="s2">&quot;section-7&quot;</span>&gt;监视窗口信息，如有内容变动，进行提示&lt;/h1&gt;
</span><span class='line'>&lt;p&gt;setw -g monitor-activity on
</span><span class='line'><span class="nb">set</span> -g visual-activity on
</span><span class='line'><span class="nb">set</span> -g status-utf8 on&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;h1 <span class="nv">id</span><span class="o">=</span><span class="s2">&quot;section-8&quot;</span>&gt;窗口号和窗口分割号都以1开始（默认从0开始）&lt;/h1&gt;
</span><span class='line'>&lt;p&gt;set -g base-index 1
</span><span class='line'>setw -g pane-base-index 1&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;h1 <span class="nv">id</span><span class="o">=</span><span class="s2">&quot;section-9&quot;</span>&gt;支持鼠标选择窗口，调节窗口大小&lt;/h1&gt;
</span><span class='line'>&lt;p&gt;setw -g mode-mouse on
</span><span class='line'><span class="nb">set</span> -g mouse-select-pane on
</span><span class='line'><span class="nb">set</span> -g mouse-resize-pane on
</span><span class='line'><span class="nb">set</span> -g mouse-select-window on
</span><span class='line'><span class="nb">set</span> -s escape-time 1&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;h1 <span class="nv">id</span><span class="o">=</span><span class="s2">&quot;c-a-ac-a&quot;</span>&gt;设置C-a a为发送C-a键&lt;/h1&gt;
</span><span class='line'>&lt;p&gt;bind a send-prefix
</span><span class='line'><span class="c"># 加载tmux配置文件的快捷键</span>
</span><span class='line'><span class="nb">bind </span>r <span class="nb">source</span>-file ~/.tmux.conf<span class="se">\;</span> display “Reloaded!”
</span><span class='line'><span class="c"># 快捷键查看man</span>
</span><span class='line'><span class="nb">bind</span> / <span class="nb">command</span>-prompt “split-window ‘exec man %%’”
</span><span class='line'>unbind “%”
</span><span class='line'>unbind “<span class="s2">&quot;”</span>
</span><span class='line'><span class="s2"># 修改默认的窗口分割快捷键，使用更直观的符号</span>
</span><span class='line'><span class="s2">bind | split-window -h</span>
</span><span class='line'><span class="s2">bind - split-window -v</span>
</span><span class='line'><span class="s2"># 选择窗口功能修改为和Screen一样的C-a “</span>
</span><span class='line'><span class="s2">bind “&quot;</span>” choose-window&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;h1 <span class="nv">id</span><span class="o">=</span><span class="s2">&quot;section-10&quot;</span>&gt;选择窗口分割快捷键&lt;/h1&gt;
</span><span class='line'>&lt;p&gt;bind h <span class="k">select</span>-pane -L
</span><span class='line'><span class="nb">bind </span>j <span class="k">select</span>-pane -D
</span><span class='line'><span class="nb">bind </span>k <span class="k">select</span>-pane -U
</span><span class='line'><span class="nb">bind </span>l <span class="k">select</span>-pane -R
</span><span class='line'><span class="c"># 选择窗口快捷键</span>
</span><span class='line'><span class="nb">bind</span> -r C-h <span class="k">select</span>-window -t :-
</span><span class='line'><span class="nb">bind</span> -r C-l <span class="k">select</span>-window -t :+
</span><span class='line'><span class="c"># 调节窗口大小快捷键</span>
</span><span class='line'><span class="nb">bind</span> -r H resize-pane -L 5
</span><span class='line'><span class="nb">bind</span> -r J resize-pane -D 5
</span><span class='line'><span class="nb">bind</span> -r K resize-pane -U 5
</span><span class='line'><span class="nb">bind</span> -r L resize-pane -R 5&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;h1 <span class="nv">id</span><span class="o">=</span><span class="s2">&quot;section-11&quot;</span>&gt;快捷调整窗口分割到全屏&lt;/h1&gt;
</span><span class='line'>&lt;p&gt;unbind Up
</span><span class='line'><span class="nb">bind </span>Up new-window -d -n tmp <span class="se">\;</span> swap-pane -s tmp.1 <span class="se">\;</span> <span class="k">select</span>-window -t tmp
</span><span class='line'>unbind Down
</span><span class='line'><span class="nb">bind </span>Down last-window <span class="se">\;</span> swap-pane -s tmp.1 <span class="se">\;</span> <span class="nb">kill</span>-window -t tmp&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;h1 <span class="nv">id</span><span class="o">=</span><span class="s2">&quot;section-12&quot;</span>&gt;快捷记录窗口内的内容到文件中&lt;/h1&gt;
</span><span class='line'>&lt;p&gt;bind P pipe-pane -o “cat »~/#W.log” <span class="se">\;</span> display “Toggled logging to ~/#W.log”
</span></code></pre></td></tr></table></div></figure></notextile></div></p>
<p>
以上配置只需要复制保存到 <code>~/.tmux.conf</code> 文件中，下次执行tmux时就生效了。
</p>
<p>
当然，tmux的高级不止在于配置功能的强大，它还支持在命令行中对指定session进行设置。利用这个特性，便可以将繁琐的工作环境初始化用脚本完成了。比如我写了如下脚本对我的工作电脑进行初始化：
<div class='bogus-wrapper'><notextile><figure class='code'><figcaption><span>init_tmux.sh  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c">#! /bin/bash</span>
</span><span class='line'><span class="nb">export </span><span class="nv">AP_7x27_PROJECT</span><span class="o">=</span><span class="s2">&quot;~/Developer/MSM7x27A-ICS-AP&quot;</span>
</span><span class='line'><span class="nb">export </span><span class="nv">MP_7x27_PROJECT</span><span class="o">=</span><span class="s2">&quot;~/Developer/MSM7x27A-ICS-MP&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="nb">export </span><span class="nv">AP_8x25_PROJECT</span><span class="o">=</span><span class="s2">&quot;~/Developer/MSM8x25-ICS-AP&quot;</span>
</span><span class='line'><span class="nb">export </span><span class="nv">MP_8x25_PROJECT</span><span class="o">=</span><span class="s2">&quot;~/Developer/MSM8x25-ICS-MP&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="k">if</span> <span class="o">[</span> -z <span class="s2">&quot;$TMUX&quot;</span> <span class="o">]</span>; <span class="k">then</span>
</span><span class='line'><span class="k">    </span>tmux has-session -t development7x27
</span><span class='line'>    <span class="k">if</span> <span class="o">[</span> <span class="nv">$?</span> !<span class="o">=</span> 0 <span class="o">]</span>; <span class="k">then</span>
</span><span class='line'>        <span class="c"># init 7x27 AP</span>
</span><span class='line'>        tmux new-session -s development7x27 -n AP_7x27 -d
</span><span class='line'>        tmux send-keys -t development7x27 <span class="s2">&quot;cd $AP_7x27_PROJECT&amp;amp;&amp;amp;. ./build/envsetup.sh&amp;amp;&amp;amp;choosecombo 1 13 1&quot;</span> C-m
</span><span class='line'>        tmux split-window -h -p 40 -t development7x27:1
</span><span class='line'>        tmux send-keys -t development7x27 <span class="s2">&quot;cd $AP_7x27_PROJECT&amp;amp;&amp;amp;. ./build/envsetup.sh&amp;amp;&amp;amp;choosecombo 1 13 1&quot;</span> C-m
</span><span class='line'>        tmux split-window -v -t development7x27:1.2
</span><span class='line'>        tmux send-keys -t development7x27 <span class="s2">&quot;cd $AP_7x27_PROJECT&amp;amp;&amp;amp;. ./build/envsetup.sh&amp;amp;&amp;amp;choosecombo 1 13 1&quot;</span> C-m
</span><span class='line'>
</span><span class='line'>        <span class="c"># init 7x27 MP</span>
</span><span class='line'>        tmux new-window -n MP_7x27 -t development7x27
</span><span class='line'>
</span><span class='line'>        tmux send-keys -t development7x27:2 <span class="s2">&quot;cd $MP_7x27_PROJECT/modem_proc/build/ms&quot;</span> C-m
</span><span class='line'>        tmux split-window -h -p 40 -t development7x27:2
</span><span class='line'>        tmux send-keys -t development7x27:2 <span class="s2">&quot;cd $MP_7x27_PROJECT/modem_proc/build/ms&quot;</span> C-m
</span><span class='line'>        tmux split-window -v -t development7x27:2.2
</span><span class='line'>        tmux send-keys -t development7x27 <span class="s2">&quot;cd $MP_7x27_PROJECT/modem_proc/build/ms&quot;</span> C-m
</span><span class='line'>
</span><span class='line'>        tmux <span class="k">select</span>-window -t development7x27:1
</span><span class='line'>        tmux <span class="k">select</span>-pane -t development7x27:1 -L
</span><span class='line'>    <span class="k">fi</span>
</span><span class='line'>
</span><span class='line'><span class="k">        </span>tmux send-keys -t development7x27:1.3 <span class="s2">&quot;export DISPLAY=$DISPLAY&quot;</span> C-m
</span><span class='line'>        tmux send-keys -t development7x27:2.3 <span class="s2">&quot;export DISPLAY=$DISPLAY&quot;</span> C-m
</span><span class='line'>
</span><span class='line'>    tmux has-session -t development8x25
</span><span class='line'>    <span class="k">if</span> <span class="o">[</span> <span class="nv">$?</span> !<span class="o">=</span> 0 <span class="o">]</span>; <span class="k">then</span>
</span><span class='line'>        <span class="c"># init 8x25 AP</span>
</span><span class='line'>        tmux new-session -s development8x25 -n AP_8x25 -d
</span><span class='line'>        tmux send-keys -t development8x25 <span class="s2">&quot;cd $AP_8x25_PROJECT&amp;amp;&amp;amp;. ./build/envsetup.sh&amp;amp;&amp;amp;choosecombo 1 17 3&quot;</span> C-m
</span><span class='line'>        tmux split-window -h -p 40 -t development8x25:1
</span><span class='line'>        tmux send-keys -t development8x25 <span class="s2">&quot;cd $AP_8x25_PROJECT&amp;amp;&amp;amp;. ./build/envsetup.sh&amp;amp;&amp;amp;choosecombo 1 17 3&quot;</span> C-m
</span><span class='line'>        tmux send-keys -t development8x25 <span class="s1">&#39;top&#39;</span> C-m
</span><span class='line'>        tmux split-window -v -t development8x25:1.2
</span><span class='line'>        tmux send-keys -t development8x25 <span class="s2">&quot;cd $AP_8x25_PROJECT&amp;amp;&amp;amp;. ./build/envsetup.sh&amp;amp;&amp;amp;choosecombo 1 17 3&quot;</span> C-m
</span><span class='line'>
</span><span class='line'>        <span class="c"># init 8x25 MP</span>
</span><span class='line'>        tmux new-window -n MP_8x25 -t development8x25
</span><span class='line'>
</span><span class='line'>        tmux send-keys -t development8x25:2 <span class="s2">&quot;cd $MP_8x25_PROJECT/modem_proc/build/ms&quot;</span> C-m
</span><span class='line'>        tmux split-window -h -p 40 -t development8x25:2
</span><span class='line'>        tmux send-keys -t development8x25:2 <span class="s2">&quot;cd $MP_8x25_PROJECT/modem_proc/build/ms&quot;</span> C-m
</span><span class='line'>        tmux split-window -v -t development8x25:2.2
</span><span class='line'>        tmux send-keys -t development8x25 <span class="s2">&quot;cd $MP_8x25_PROJECT/modem_proc/build/ms&quot;</span> C-m
</span><span class='line'>
</span><span class='line'>        tmux <span class="k">select</span>-window -t development8x25:1
</span><span class='line'>        tmux <span class="k">select</span>-pane -t development8x25:1 -L
</span><span class='line'>    <span class="k">fi</span>
</span><span class='line'>
</span><span class='line'><span class="k">        </span>tmux send-keys -t development8x25:1.3 <span class="s2">&quot;export DISPLAY=$DISPLAY&quot;</span> C-m
</span><span class='line'>        tmux send-keys -t development8x25:2.3 <span class="s2">&quot;export DISPLAY=$DISPLAY&quot;</span> C-m
</span><span class='line'>
</span><span class='line'>    tmux attach -t development7x27
</span><span class='line'><span class="k">fi</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
脚本主体思想为每次运行时判断相应的tmux session是否存在，如果存在则设置Xwindow的变量后attach；如果不存在相应session，则新建相应session并初始化session中相应窗口和窗口分割，同时在每个窗口分割中运行每次都要运行的环境初始化命令。最后设置Xwindow环境变量后attach。我的脚本中分别初始化了高通7x27 AP和MP的编译环境以及8x25 AP和MP的编译环境。
</p>
<p>
使用时，将以上内容存为文件，并在 <code>~/.bashrc</code> 中调用就可以了。这样，不论是ssh到该主机还是新开一个终端窗口，都会直接进入指定的tmux session中，继续之前的工作。加上Xwindow的设置，tmux中也可以直接运行X程序。工作中，我就是在windows上使用putty+Xming来运行使用X程序的，非常方便高效。简单的配置让工作环境大幅改进，让我觉得之前6刀买到那本书真是超值了。
</p>
<p>
说了这么多好，tmux其实也是有缺点的。最明显的一个缺点就是不支持windows，而GNU Screen却支持是windows的，这不免让人有点遗憾。所以如果有在Windows下使用类似软件的话（真的有需要吗？），只能考虑其它如GNU Screen之类的软件了。
</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[最近看完的两本书]]></title>
    <link href="http://blog.xeonxu.info/blog/2012/10/29/zui-jin-kan-wan-de-liang-ben-shu/"/>
    <updated>2012-10-29T22:23:00+08:00</updated>
    <id>http://blog.xeonxu.info/blog/2012/10/29/zui-jin-kan-wan-de-liang-ben-shu</id>
    <content type="html"><![CDATA[<p>
近日看完两本关于Slackware的入门书，一本是大名鼎鼎的《Slackware Linux Essentials》，另一本是《Slackware Linux Basics》。之所以想起来看Slackware相关的书，是因为人生接触的第一个Linux发行版就是Slackware。那时候家里没有网络，从报纸上知道了开源软件和Linux的存在。后来在书店里看到了电子工业出版社出版的《Linux大全》，那是一本很厚的书，书的背面印着获取书中描述的Linux版本的方法，我就是从那里获取到的人生第一个Linux发行版。原版书提供三个Linux发行版可供选择，而电子工业出版社只提供其中的两个发行版，一个是人们熟知的RedHat，而另一个就是Slackware。当时本人处于对计算机技术极度痴迷的状态，总是希望能有一些挑战，所以选择邮购了其中安装及配置较为复杂的一个发行版，也就是Slackware。当然，最后从拿到Slackware光盘，到安装并简单配置到能使用确实花了不少时间，也因为如此，我对Slackware的印象才如此深刻。之后在大学的时候自己买过RedHat/Fedora并用了那么几次，工作了后接触更多的是Ubuntu，但是随着Linux使用经验的逐渐增长以及知识的不断积累，越发觉得之后使用的那些Linux发行版似乎都缺少了一点什么，这种感觉说不上来，但是这种隐隐约约的感觉将我的目光再次引向Slackware发行版。
</p>
<p>
碰巧，前段时间从网上买过一台Raspberry Pi<sup><a class="footref" name="fnr.1" href="#fn.1">1</a></sup>，而且正好，又有爱好者将ArmedSlack<sup><a class="footref" name="fnr.2" href="#fn.2">2</a></sup>移植到了Raspberry Pi上，理所当然，我的Raspberry Pi便跑上了Slackware。可惜，虽说最早接触的是Slackware，但是自己对Slackware的了解并不系统，所以下定决心说一定要看完至少一本关于Slackware的著作。于是，才从网上找到上述的两本书。还好，从目前情况来看，这个任务算是完成了，而且超标了。
</p>
<p>
现在说说才看完的这两本书，作为Slackware Linux的官方教材《Slackware Linux Essentials》<sup><a class="footref" name="fnr.3" href="#fn.3">3</a></sup>更新并不频繁，目前作者正在编写第三版，但是该版尚处于Beta状态<sup><a class="footref" name="fnr.4" href="#fn.4">4</a></sup>，所以市面上能买到的只有第二版。鉴于前者更新不够及时，导致了《Slackware Linux Basics》<sup><a class="footref" name="fnr.5" href="#fn.5">5</a></sup>的出现。从名字上看，前者似乎比后者更加全面，但从本人阅读下来的感觉来说，Basics的内容明显要比Essentials的深入一些；从页数上来说，Basics的相比也要多一些，但是这并不是说两本书哪本更好。单从入门角度来讲，我觉得Essentials的内容更适合入门学习；Basics的内容作为Essentials的补充，适合进阶学习。总体来讲，两本书可以互相参考学习。就本人经验，看完其中一本后，另外一本可以很快看完，因为只需要看差异的部分就可以了。虽然这两本书都以Slackware为切入点，但是其内容对于其它发行版也是部分适用的。所以，不论对于想学Slackware还是想学Linux的同学，我是极力推荐去看这两本书的，比市面上买的那些翻译山寨教学书好过不少。至于需要书的同学，可以去脚注找找，两本书官方都提供常用电子档下载，而我是用软件将HTML转成了kindle格式在kindle上读完这两本书的。
</p>
<p>
另外，做个预告，我打算将Raspberry Pi打造为基于ArmedSlack系统的“科学上网机”，目前基本成型，具体实现方法和相关软件会随着博客的更新逐步公开。
</p>
<div id="footnotes">
<h2 class="footnotes">Footnotes: </h2>
<div id="text-footnotes">
<p class="footnote"><sup><a class="footnum" name="fn.1" href="#fnr.1">1</a></sup> <a href="http://www.raspberrypi.org">http://www.raspberrypi.org</a>
</p>


<p class="footnote"><sup><a class="footnum" name="fn.2" href="#fnr.2">2</a></sup> 一款基于ARM芯片的Slackware Linux发行版，网址：<a href="http://www.armedslack.org">http://www.armedslack.org</a>
</p>


<p class="footnote"><sup><a class="footnum" name="fn.3" href="#fnr.3">3</a></sup> <a href="http://slackbook.org">http://slackbook.org</a>
</p>


<p class="footnote"><sup><a class="footnum" name="fn.4" href="#fnr.4">4</a></sup> <a href="http://slackbook.org/beta/">http://slackbook.org/beta/</a>
</p>


<p class="footnote"><sup><a class="footnum" name="fn.5" href="#fnr.5">5</a></sup> <a href="http://code.google.com/p/support/">http://code.google.com/p/support/</a>
</p>



</div>
</div>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[小脚本帮大忙]]></title>
    <link href="http://blog.xeonxu.info/blog/2012/10/21/xiao-jiao-ben-bang-da-mang/"/>
    <updated>2012-10-21T23:38:00+08:00</updated>
    <id>http://blog.xeonxu.info/blog/2012/10/21/xiao-jiao-ben-bang-da-mang</id>
    <content type="html"><![CDATA[<p>
前两天单位的在做项目中发现一个Bug：手机在启动后触摸屏有一定几率无法使用。这个Bug非常恼人，因为重现几率非常低，而且只会出现在重启过程中。这意味着不论是调查原因还是验证对策，都将是非常耗时且繁琐的。因为对策问题之前，首先需要重现问题，如此才好分析问题的原因。而这个Bug必须要反复重启手机才能重现，人为操作的话太浪费时间效率低下。
好在这个Bug的行为比较稳定，重现后触屏肯定不能使用。通过adb对比调查正常手机和问题手机的设备节点，发现在出问题的手机中，触屏设备没有注册成功。看来是设备注册失败，导致的触屏异常。于是，我们考虑使用脚本对该Bug进行再现分析。思路如下：
</p>
<ol>
<li>写一个脚本判断触屏驱动的设备节点是否注册成功，如果成功则复位重启；否则保留现场等待分析。
</li>
<li>将该脚本添加到 <code>init.rc</code> 中成为一个服务，在启动时调用。
</li>
<li>脚本运行时将相应的运行信息输出到外部文件中，从而可以计算出再现率。
</li>
</ol>

<p>基于以上想法，写出了以下脚本代码：
<div class='bogus-wrapper'><notextile><figure class='code'><figcaption><span>check_tp.sh  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c">#!/system/bin/sh</span>
</span><span class='line'><span class="nv">tp_name</span><span class="o">=</span><span class="s2">&quot;xxxx&quot;</span> <span class="c"># xxxx为注册的tp名称</span>
</span><span class='line'><span class="nv">input_name</span><span class="o">=</span><span class="sb">`</span>cat /sys/class/input/input0/name<span class="sb">`</span>
</span><span class='line'><span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;x_$tp_name&quot;</span> <span class="o">=</span> <span class="s2">&quot;x_$input_name&quot;</span> <span class="o">]</span>; <span class="k">then</span>
</span><span class='line'><span class="k">    </span><span class="nb">echo</span> <span class="s2">&quot;`date` touch screen is OK.&quot;</span> &amp;gt;&amp;gt; /data/check_tp.log
</span><span class='line'>    reboot
</span><span class='line'><span class="k">else</span>
</span><span class='line'><span class="k">    </span><span class="nb">echo</span> <span class="s2">&quot;`date` touch screen is not OK.&quot;</span> &amp;gt;&amp;gt; /data/check_tp.log
</span><span class='line'><span class="k">fi</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
同时，修改 <code>init.rc</code> 文件，在其中加入：
<div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>service check_tp /system/bin/sh /system/bin/check_tp.sh
</span><span class='line'>    class main
</span><span class='line'>    oneshot
</span></code></pre></td></tr></table></div></figure></notextile></div>
然后重新编译bootimage并刷机。最后使用 <code>adb remount&amp;&amp;adb push check_tp.sh /system/bin/&amp;&amp;adb shell chmod 755 /system/bin/check_tp.sh</code> ，将刚才新写的脚本推送到手机上。重启手机，之后就会看到手机不断的上电然后复位重启。
在运行该脚本不断重启手机8小时之后，手机正常进入了系统。此时操作手机进行验证，发现触屏已经无效。分析 <code>/data/check_tp.log</code> 文件，算出手机共重启了1000多次，从而得出该问题的再现率大概为千分之一。利用该脚本，验证bug方便了好多，大大提高了工作效率。
</p>

<div id="outline-container-1" class="outline-2">
<h2 id="sec-1">后记</h2>
<div class="outline-text-2" id="text-1">

<p>由于以上写的脚本使用到了 <code>if</code> 关键字，而Android系统默认不支持该关键字，必须依赖busybox环境才行。之前我有移植过busybox，但是只在工程模式下生效，所以该脚本在release版本中是不能正常运行的。为了不依赖运行环境，我又将该脚本换了一种写法，改为：
<div class='bogus-wrapper'><notextile><figure class='code'><figcaption><span>check_tp2.sh  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c">#!/system/bin/sh</span>
</span><span class='line'><span class="nv">tp_name</span><span class="o">=</span><span class="s2">&quot;xxxx&quot;</span> <span class="c"># xxxx为注册的tp名称</span>
</span><span class='line'><span class="nv">input_name</span><span class="o">=</span><span class="sb">`</span>cat /sys/class/input/input0/name<span class="sb">`</span>
</span><span class='line'><span class="k">case</span> <span class="nv">$input_name</span> in
</span><span class='line'>    <span class="nv">$tp_name</span><span class="o">)</span> <span class="nb">echo</span> <span class="s2">&quot;`date` touch screen is OK.&quot;</span> &amp;gt;&amp;gt; /data/check_tp.log
</span><span class='line'>              reboot
</span><span class='line'>             ;;
</span><span class='line'>    *<span class="o">)</span> <span class="nb">echo</span> <span class="s2">&quot;`date` touch screen is not OK.&quot;</span> &amp;gt;&amp;gt; /data/check_tp.log
</span><span class='line'>            ;;
</span><span class='line'><span class="k">esac</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
这样，即便是在Android原生环境中，也可以正确无误的运行。这样就能将该脚本发给测试，利用它对release版本进行bug验证了。
</p></div>
</div>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[在Android编译时建立符号链接]]></title>
    <link href="http://blog.xeonxu.info/blog/2012/10/08/zai-androidbian-yi-shi-jian-li-fu-hao-lian-jie/"/>
    <updated>2012-10-08T21:48:00+08:00</updated>
    <id>http://blog.xeonxu.info/blog/2012/10/08/zai-androidbian-yi-shi-jian-li-fu-hao-lian-jie</id>
    <content type="html"><![CDATA[<p>
最近接到一个任务，需要将Busybox环境移植到高通平台的Android项目上。Busybox的目标执行文件有现成编译好的，需要做的工作就是添加一个Android工程，将编译好的二进制文件拷贝到Android的文件系统中，同时还需要生成相应的Busybox命令链接。
</p>
<p>
拷贝文件到指定目录在Android的编译系统中有现成的方法，使用下面这个方法即可：
<div class='bogus-wrapper'><notextile><figure class='code'><figcaption><span>拷贝文件到指定目录  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='makefile'><span class='line'><span class="nv">LOCAL_PATH</span> <span class="o">:=</span> <span class="k">$(</span>call my-dir<span class="k">)</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Add busybox environment zhiqiang.xu 2012.10.8</span>
</span><span class='line'><span class="cp">include $(CLEAR_VARS)</span>
</span><span class='line'>LOCAL_MODULE :<span class="o">=</span> busybox_modules
</span><span class='line'>LOCAL_MODULE_STEM :<span class="o">=</span> busybox
</span><span class='line'>LOCAL_SRC_FILES :<span class="o">=</span> busybox
</span><span class='line'>LOCAL_MODULE_TAGS :<span class="o">=</span> eng
</span><span class='line'>LOCAL_MODULE_CLASS :<span class="o">=</span> EXECUTABLES
</span><span class='line'>LOCAL_MODULE_PATH :<span class="o">=</span> <span class="k">$(</span>TARGET_OUT<span class="k">)</span>/busybox
</span><span class='line'><span class="cp">include $(BUILD_PREBUILT)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
由于Busybox环境主要用于工程调试，所以模块设置为只在eng编译模式下有效。按照以上这段设置，可以将busybox执行文件拷贝到Android文件系统中的 <code>/system/busybox</code> 目录下。
</p>
<p>
而对于生成链接，之前没有接触过。不过在搜索调查了已有的Android工程文件之后，发现系统中也提供了现成的方法，如下：
<div class='bogus-wrapper'><notextile><figure class='code'><figcaption><span>recovery使用的软链生成方法  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='makefile'><span class='line'><span class="nv">BUSYBOX_LINKS</span> <span class="o">:=</span> <span class="k">$(</span>shell cat external/busybox/busybox-minimal.links<span class="k">)</span>
</span><span class='line'><span class="cp">ifndef BOARD_HAS_SMALL_RECOVERY</span>
</span><span class='line'>exclude :<span class="o">=</span> tune2fs
</span><span class='line'><span class="cp">ifeq ($(BOARD_HAS_LARGE_FILESYSTEM),true)</span>
</span><span class='line'>exclude +<span class="o">=</span> mke2fs
</span><span class='line'><span class="cp">endif</span>
</span><span class='line'><span class="cp">endif</span>
</span><span class='line'>RECOVERY_BUSYBOX_SYMLINKS :<span class="o">=</span> <span class="k">$(</span>addprefix <span class="k">$(</span>TARGET_RECOVERY_ROOT_OUT<span class="k">)</span>/sbin/,<span class="k">$(</span>filter-out <span class="k">$(</span>exclude<span class="k">)</span>,<span class="k">$(</span>notdir <span class="k">$(</span>BUSYBOX_LINKS<span class="k">))))</span>
</span><span class='line'><span class="k">$(</span>RECOVERY_BUSYBOX_SYMLINKS<span class="k">)</span>: BUSYBOX_BINARY :<span class="o">=</span> busybox
</span><span class='line'><span class="k">$(</span>RECOVERY_BUSYBOX_SYMLINKS<span class="k">)</span>: <span class="k">$(</span>LOCAL_INSTALLED_MODULE<span class="k">)</span>
</span><span class='line'>        @echo <span class="s2">&quot;Symlink: $@ -&amp;gt; $(BUSYBOX_BINARY)&quot;</span>
</span><span class='line'>        @mkdir -p <span class="k">$(</span>dir <span class="nv">$@</span><span class="k">)</span>
</span><span class='line'>        @rm -rf <span class="nv">$@</span>
</span><span class='line'>        <span class="k">$(</span>hide<span class="k">)</span> ln -sf <span class="k">$(</span>BUSYBOX_BINARY<span class="k">)</span> <span class="nv">$@</span>
</span><span class='line'>
</span><span class='line'>ALL_DEFAULT_INSTALLED_MODULES +<span class="o">=</span> <span class="k">$(</span>RECOVERY_BUSYBOX_SYMLINKS<span class="k">)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>
实现方法使用了标准的Makefile目标，在 <code>$(RECOVERY_BUSYBOX_SYMLINKS)</code> 目标下生成相应链接，看起来似乎是只要将Makefile的目标添加到 <code>ALL_DEFAULT_INSTALLED_MODULES</code> 这个变量后，编译的时候就会按照Makefile的标准生成目标。实验后确实可行，不过同时我也发现了一个不足。那就是使用这种方法后，通过mm/mmm命令进行模块编译的时候是没法正确执行的。换言之， <code>ALL_DEFAULT_INSTALLED_MODULES</code> 变量只有在系统完全编译的时候才会被调用。为此，领悟范例的精神后，自己改了一下实现方法，如下：
</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><figcaption><span>修改后的生成软链的方法  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='makefile'><span class='line'><span class="cp">ifneq (,$(filter userdebug eng,$(TARGET_BUILD_VARIANT)))&lt;/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="err">&lt;p&gt;define</span> <span class="err">_make_link</span>
</span><span class='line'>   <span class="k">$(</span>shell <span class="nb">echo</span> “Symlink: <span class="k">$(</span>1<span class="k">)</span> -&amp;gt; <span class="k">$(</span>2<span class="k">)</span>”<span class="k">)</span>
</span><span class='line'>   <span class="k">$(</span>shell mkdir -p <span class="k">$(</span>dir <span class="k">$(</span>1<span class="k">)))</span>
</span><span class='line'>   <span class="k">$(</span>shell rm -rf <span class="k">$(</span>1<span class="k">))</span>
</span><span class='line'>   <span class="k">$(</span>shell ln -sf <span class="k">$(</span>2<span class="k">)</span> <span class="k">$(</span>1<span class="k">))</span>
</span><span class='line'>endef&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;h1 <span class="nv">id</span><span class="o">=</span><span class="s2">&quot;add-busybox-environment-zhiqiangxu-2012108&quot;</span>&gt;Add busybox environment zhiqiang.xu 2012.10.8&lt;/h1&gt;
</span><span class='line'>&lt;p&gt;# Now <span class="nb">let</span>’s <span class="k">do </span>busybox symlinks
</span><span class='line'>BUSYBOX_LINKS :<span class="o">=</span> <span class="k">$(</span>shell cat <span class="k">$(</span>LOCAL_PATH<span class="k">)</span>/busybox.links<span class="k">)</span>
</span><span class='line'>BUSYBOX_SYMLINKS :<span class="o">=</span> <span class="k">$(</span>addprefix <span class="k">$(</span>TARGET_OUT<span class="k">)</span>/busybox/,<span class="k">$(</span>notdir <span class="k">$(</span>BUSYBOX_LINKS<span class="k">)))</span>
</span><span class='line'>BUSYBOX_BINARY :<span class="o">=</span> /system/busybox/<span class="k">$(</span>LOCAL_SRC_FILES<span class="k">)</span>
</span><span class='line'><span class="k">$(</span>foreach _item, <span class="k">$(</span>BUSYBOX_SYMLINKS<span class="k">)</span>, <span class="se">\</span>
</span><span class='line'>       <span class="k">$(</span><span class="nb">eval</span> <span class="k">$(</span>call _make_link,<span class="k">$(</span>_item<span class="k">)</span>,<span class="k">$(</span>BUSYBOX_BINARY<span class="k">))))</span>&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;_make_link :<span class="o">=</span>
</span><span class='line'><span class="cp">endif</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>
<p>
修改后的方法使用了自定义宏，不论是全系统编译还是使用mm/mmm进行模块编译，每次编译的时候宏都会展开执行。同时为了区分编译模式，我又添加了相应的判断宏 <code>ifneq (,$(filter userdebug eng,$(TARGET_BUILD_VARIANT)))</code> 将执行部分包括在里面。实验下来效果良好，可以根据当前设定的编译模式生成或者不生成相应软链。
最后，发现一点，我修改的这个方法由于没有依赖目标，所以每次编译的时候都会执行一遍，编译效率不高，所以这种结构不能用于大负荷的处理工作。好在生成软链不是多重的工作，这么用用也无什么大碍。
</p>
]]></content>
  </entry>
  
</feed>
